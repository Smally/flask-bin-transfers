<!DOCTYPE HTML>
<html>
<head>
    <title>SAP B1 Stock Transfer</title>
    <script src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js" data-sap-ui-theme="sap_fiori_3"></script>
    <script>
        sap.ui.define([
            "sap/m/MessageBox",
            "sap/m/Input",
            "sap/m/Button",
            "sap/m/Label",
            "sap/m/Table",
            "sap/m/Column",
            "sap/m/Text",
            "sap/m/ColumnListItem",
            "sap/ui/model/json/JSONModel",
            "sap/m/CheckBox"
        ], function(MessageBox, Input, Button, Label, Table, Column, Text, ColumnListItem, JSONModel, CheckBox) {
            var app = new sap.m.App({initialPage:"mainPage"});
            var page = new sap.m.Page({
                title: "Verify Inventory at Bin",
                content: [
                    new Label({ text: "Enter Bin Location:" }),
                    new Input({ id: "binInput", placeholder: "Type bin location..." }),
                    new Button({ text: "Search", press: searchBin }),
                    new Table({
                        id: "productsTable",
                        items: {
                            path: "/value",
                            template: new ColumnListItem({
                                cells: [
                                    new Text({text: "{ProductCode}"}),
                                    new Text({text: "{Batch}"}),
                                    new Text({text: "{Quantity}"}),
                                    new CheckBox({
                                        selected: "{Confirmed}",
                                        select: function(evt) {
                                            var context = evt.getSource().getBindingContext();
                                            context.getModel().setProperty(context.getPath() + "/Confirmed", evt.getParameter("selected"));
                                        }
                                    })
                                ]
                            })
                        },
                        columns: [
                            new Column({ header: new Text({ text: "Product Code" }) }),
                            new Column({ header: new Text({ text: "Batch" }) }),
                            new Column({ header: new Text({ text: "Quantity" }) }),
                            new Column({ header: new Text({ text: "Confirm" }) })
                        ]
                    }),
                    new Button({ text: "Send Transfer", press: sendTransfer })
                ]
            });
            app.addPage(page);
            app.placeAt("content");

            function searchBin() {
                var binLocation = sap.ui.getCore().byId("binInput").getValue();
                jQuery.ajax({
                    url: '/search_bin?bin_location=' + encodeURIComponent(binLocation),
                    type: 'GET',
                    success: function(data) {
                        var oModel = new JSONModel(data);
                        sap.ui.getCore().byId("productsTable").setModel(oModel);
                    },
                    error: function() {
                        MessageBox.error("Failed to fetch data.");
                    }
                });
            }

            function sendTransfer() {
                var oTable = sap.ui.getCore().byId("productsTable");
                var oItems = oTable.getItems();
                var oData = [];
                oItems.forEach(function(item) {
                    var context = item.getBindingContext();
                    var data = context.getModel().getProperty(context.getPath());
                    if(data.Confirmed) {
                        oData.push(data);
                    }
                });
                if(oData.length > 0) {
                    // Send this data to Flask which will handle the SAP B1 Service Layer
                    jQuery.ajax({
                        url: '/create_transfer',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(oData),
                        success: function(response) {
                            MessageBox.success("Transfer successful!");
                        },
                        error: function() {
                            MessageBox.error("Failed to send transfer.");
                        }
                    });
                } else {
                    MessageBox.warning("No items confirmed for transfer.");
                }
            }
        });
    </script>
</head>
<body class="sapUiBody" id="content"></body>
</html>
